<!doctype html><html lang=en-us><!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=author content="Fabien P√©an"><meta name=google-site-verification content="_OCqKj2I4fVqJsqpa9uq0utQ55W1kx93lTIQtHZ88mM"><link rel="shortcut icon" type=image/png href=/img/logo.svg><title>Fabien P√©an &#183; Personal Website</title>
<meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><link rel=stylesheet type=text/css href=/css/normalize.css><link rel=stylesheet href=/vendor/colors/css/colors.min.css><link rel=stylesheet href=/vendor/academicons/css/academicons.min.css><style>:root{--font-monospace:"Source Code Pro";--font-sans-serif:"Inter"}</style><link href="https://fonts.googleapis.com/css?family=Inter%7cSource+Code+Pro&amp;display=swap" rel=stylesheet type=text/css><link rel=stylesheet href=/css/custom.css></head><body><body><nav id=nav><figure id=logo class=image><img src=/img/logo.svg></figure><div id=branding><div class=branding-title>Fabien P√©an</div><div class=branding-subtitle></div></div><div id=menu><a class=menu-link href=/><div class=menu-item><span class=menu-label><i class="fas fa-home fa-fw"></i>&nbsp;Home</span></div></a><a class=menu-link href=/news><div class=menu-item><span class=menu-label><i class="fas fa-newspaper fa-fw"></i>&nbsp;News</span></div></a><a class=menu-link href=/blog><div class=menu-item><span class=menu-label><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;Blog</span></div></a><a class=menu-link href=/notes><div class=menu-item><span class=menu-label><i class="fas fa-sticky-note fa-fw"></i>&nbsp;Notes</span></div></a><a class=menu-link href=/projects><div class=menu-item><span class=menu-label><i class="fas fa-book fa-fw"></i>&nbsp;Projects</span></div></a></div><div class=social><div class=social-list><div style="display:flex;flex-flow:row wrap;justify-content:center"><div class="social-button email"><a href=mailto:fabien@pean.pro rel=author><i class="fas fa-at fa-2x"></i></a></div><div class="social-button bitbucket"><a href=https://bitbucket.org/FabienPean rel="author external"><i class="fab fa-bitbucket fa-2x"></i></a></div><div class="social-button github"><a href=https://github.com/FabienPean rel="author external"><i class="fab fa-github fa-2x"></i></a></div><div class="social-button linkedin"><a href=https://www.linkedin.com/in/FabienPean rel="author external"><i class="fab fa-linkedin fa-2x"></i></a></div></div></div></div></nav><main id=main><div class=content><h1>Deep down the FOSS: an unexpected journey</h1><small><div class=subtitle style="display:flex;flex-flow:row wrap;justify-content:space-between"><span style="flex:1 0 auto;max-width:100%"><span>08/04/2023</span>&nbsp;&boxv;&nbsp;<a href=/blog>Blog</a></span><div class=tag-list></div></div></small><br><h2 id=once-upon-a-vegafem>Once upon a VegaFEM</h2><p>It all began with a spark&mldr;</p><p>On my spare time, I decided to sharpen my skills and change my mind by toying with <a href=https://viterbi-web.usc.edu/~jbarbic/vega/>VegaFEM</a>, an open-source (<a href=https://spdx.org/licenses/BSD-3-Clause.html>BSD-3-Clause</a>) middleware providing facilities for soft-body simulation in the realm of computer graphics. It has been developed by <a href=http://www.jernejbarbic.com/>Jernej Barbiƒç</a> and his group over many years, yet, it does not have an official release on any major git repository hosting websites. Its distribution occurs through the personal webpage, and copies elsewhere are often ephemeral results of isolated contributors. I decided to give a go on my own with the latest version (4.0.0) and let <a href=https://github.com/FabienPean/VegaFEM>my repository</a> join the rank of numerous forks. Doing so with this library offers the possibility to work on many aspects related to devops, maintenance, and development.</p><h2 id=the-trigger-arpack>The trigger ARPACK</h2><p>VegaFEM is a library mixing generously C and C++ formalism, and mostly developed on Linux systems, for which it offers a <a href=https://en.wikipedia.org/wiki/Make_(software)>Makefile</a>. There are solution files provided for Visual Studio, however, setting up the dependencies is up to the user and not all them are easily available. Among them, there is ARPACK.</p><p><a href=https://en.wikipedia.org/wiki/ARPACK>ARPACK</a>, short for Arnoldi Package, is a <abbr title=üò±>Fortran 77</abbr> library for solving eigenproblems on large sparse linear system in a matrix-free fashion.</p><p>ARPACK is used as a solver in an utility application ‚Äî <em>the large modal deformation factory</em>. This technique improves the simulation time (= more FPS) by significantly reducing the number of unknowns (= fewer calculations)<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. The gist of it is to approximate a complex motion by a linear combination of a few vectors<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> (deformation modes, or eigenvectors). More on those technical aspects perhaps one day&mldr;</p><p>Problem, ARPACK is not easy to come by on Windows, so it clashed with my multi-OS CI pipeline plans.</p><h2 id=twists-and-turns>Twists and turns</h2><h3 id=replacing-arpack->Replacing ARPACK ?</h3><p>I was aware of the library <a href=https://spectralib.org>Spectra</a>, which is supposed to offer similar facilities as ARPACK, a modern take on the problem and being C++ first. However, it would mean diving into the code replacing some components, besides adding dependency on <a href=https://eigen.tuxfamily.org>Eigen</a>. Quite some big changes, and a line I was not willing to cross at that point since I am aiming to remain as close as possible to the source material.</p><h3 id=arpack-ng-to-the-rescue>ARPACK-NG to the rescue</h3><p>The main website for ARPACK is (long?) dead, however, out of its ashes rose a common effort to maintain it: <a href=https://github.com/opencollab/arpack-ng>ARPACK-NG</a>. Several major applications rely on it for computing eigenvalues and eigenvectors, such as Octave, Scilab, or Mathematica. The latest version of the repository was not so recent, on December 2020, but changes are still actively committed. To my surprise, the repository seems to support CMake as build generator.</p><h3 id=vcpkg-my-old-friend>VCPKG my old friend</h3><p>Package managers are not standardized in the Fortran and C++ ecosystem. Unlike Rust or Node.js, one has a (too many) choices to acquire and integrate dependencies in a project. Bonus point for flexibility, yet a failing grade for uniformity.</p><p>I have enjoyed using vcpkg for a long time. It is particularly great on Windows because it simplifies tremendously C++ development for consuming third party libraries. Besides, it is well integrated with Visual Studio, but more importantly, multiplatform.</p><p>I was already using vcpkg for other dependencies needed by VegaFEM, such as OpenGL, FreeGLUT, TBB, etc. Therefore, I decided to bring ARPACK to vcpkg instead of relying on other mechanisms, such as git submodule or CMake (ExternalProject/FetchContent), for this sole dependency.</p><p>A previous search let me know I was <a href=https://github.com/microsoft/vcpkg/pull/22803>not the first</a> to look into it. The effort was halted because upstream changes were needed prior to merging the contribution. The author contributed significantly in ARPACK-NG to improve the CMake files, and thanks to their effort, my version of the port version ran successfully on Linux (via WSL) , even on Windows!&mldr; For <em>all</em> (common) triplets? No, one triplet held stubbornly against the developer assault.</p><h3 id=completionism-to-some-extents>Completionism to some extents</h3><p>The port was not playing nice as a static library when tested on Windows (with triplet <code>x64-windows-static</code>). The reason was found quickly, but mostly by luck. I was quite zealous and added the BLAS and LAPACK dependencies of ARPACK in the <code>CMakeLists</code> file myself with the following line <code>target_link_libraries(main LAPACK::LAPACK BLAS::BLAS)</code>, because I was not trusting the installed CMake targets for ARPACK to do so.</p><p>However, once I removed it, the compilation failed with nasty undefined reference to some obscure Fortran function during link time. Thus, my initial assumption was that the install configuration was lacking declaring those dependencies. Digging further, I was wrong:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#6272a4># Summarized content
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>find_dependency</span>(<span style=color:#f1fa8c>BLAS</span> <span style=color:#f1fa8c>REQUIRED</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>find_dependency</span>(<span style=color:#f1fa8c>LAPACK</span> <span style=color:#f1fa8c>REQUIRED</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>add_library</span>(<span style=color:#f1fa8c>arpackng</span> <span style=color:#f1fa8c>SHARED</span> <span style=color:#f1fa8c>IMPORTED</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>set_target_properties</span>(<span style=color:#f1fa8c>arpackng</span> <span style=color:#f1fa8c>PROPERTIES</span>
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>INTERFACE_INCLUDE_DIRECTORIES</span> <span style=color:#f1fa8c>&#34;${_IMPORT_PREFIX}/include&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f1fa8c>INTERFACE_LINK_LIBRARIES</span> <span style=color:#f1fa8c>&#34;BLAS::BLAS LAPACK::LAPACK&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>Analyzing further after this new insight the (thinned out) compilation logs allowed for a simple diff</p><table><thead><tr><th style=text-align:left>‚ùå</th><th style=text-align:left>‚úîÔ∏è</th></tr></thead><tbody><tr><td style=text-align:left><code>/usr/bin/c++ -O2 -g -DNDEBUG CMakeFiles/main.dir/main.cpp.o -o main libarpack.a libopenblas.a liblapack.a -lm /usr/lib/x86_64-linux-gnu/libgfortran.so.5 -lgfortran -lquadmath</code></td><td style=text-align:left><code>/usr/bin/c++ -O2 -g -DNDEBUG CMakeFiles/main.dir/main.cpp.o -o main libarpack.a liblapack.a -lm /usr/lib/x86_64-linux-gnu/libgfortran.so.5 libopenblas.a -lgfortran -lquadmath</code></td></tr></tbody></table><p>Where the only difference was the link order of <a href=http://www.openblas.net>OpenBLAS</a>. Changing the link order to LAPACK then BLAS fixed the <a href=https://github.com/opencollab/arpack-ng/pull/384>issue</a>. Indeed, <a href=https://stackoverflow.com/a/409470/4709428>link order matters</a>, especially for static libraries. Little did I know that link order with static libraries with CMake is a complex topic, with a <a href=https://cmake.org/cmake/help/latest/manual/cmake-generator-expressions.7.html#genex:LINK_LIBRARY>possible solution</a> only available from CMake 3.24.</p><p>The second problem was that the library built tests by default with no way to prevent it. Thankfully, the solution for this is <a href=https://github.com/opencollab/arpack-ng/pull/385>straightforward</a>: to guard building the tests by a variable. To respect existing usage, it is on by default.</p><h3 id=the-macos-plateau>The macOS plateau</h3><p>Happy of my findings, I want to bring them to the world by contributing back. Thus, I create one PR for each of those changes and wait worriless for the CI to pass&mldr;</p><p>QUOIII ?</p><p>The pull requests are passing for all jobs&mldr; all but macOS ones.</p><p>All those jobs run until timeout or don&rsquo;t even start. In an unfortunate turn of event, a search (<a href=https://github.com/actions/runner-images/issues/6384>actions/runner-images#6384</a>) showed that the <code>macos-latest</code> image for Github Actions runners switches from macOS 11 to macOS 12 during that period, with scheduled downtime. Alas, one shall not merge unless the holy CI turns a uniform green. After the outage, the CI runs again and&mldr; fails again for macOS. ARGHHH ! The switch to macOS 12 led to some newly found incompatibilities.</p><p>After a month seeing no sign of progress on the resolution of the problem, I decide to wear my get-it-done belt to not let my PRs join the shadow realm of <abbr title="a consensual term for rotting ü§°">stalled</abbr> contributions. <abbr title="ok not so much actually">Sadly</abbr> I do not possess such a machine at home, I had to rely on the CI for feedback on my changes. Yes, this would be undesirable in a professional context, but it is on my personal time and I am not (that much) in a rush. In the same time, I discovered <a href=https://github.com/features/codespaces>Github Codespace</a>, a nice tool starting in seconds from a single button press which starts a virtual machine in the cloud with a VS Code interface and a readily checked out repository. This makes simple multi-file edits much simpler compared to setting up the repository and environment locally, a blessing for a contributing üêù like me.</p><p>When diving into details of the workflow file, I noticed that macOS variants, already using <code>macos-latest</code> were upgrading the OS. Now it made sense why one of the step was taking so long ‚Äî 40min while all other jobs are a matter of minutes ‚Äî it sure kills momentum !&mldr; And IMHO, it defeats a bit the purpose of a CI pipeline meant to test a fixed set of supported platforms.</p><p>OK, let&rsquo;s summarize, we have a CI job that upgrades the OS and a failing step. If the OS was already upgraded before the encountered problem, then it was already on macOS 12 or later, ruling out <em>de facto</em> an OS problem (after checking that both were upgraded to the same version, of course). Looking at the new image release announcement for breaking changes or differences in environment setup, it turns out that I am not the only one, yey !</p><p>The macOS image changed the Python installation of version 3.12 from homebrew (like all version ‚â§ 3.11) to the system package manager. Effectively, this broke the homebrew installation which required a <a href=https://github.com/opencollab/arpack-ng/pull/389>repair</a>.</p><h3 id=the-c-standard-chasm>The C++ standard chasm</h3><p>A very strange issue occurred on Windows with Visual Studio, where, switching to C++17 or above led a working example build to fail. An investigation led to the following information</p><p>Starting with the <a href=https://eel.is/c++draft/complex.h.syn>C++17 standard</a>, the C header <code>&lt;complex.h></code> is mandated to include ‚Äî¬†and be replaced by ‚Äî the content of <code>&lt;complex></code>, the C++ standard alternative. In substance, it is the C header wrapped up inside the <em>std</em> namespace. However, Microsoft does not implement fully compliant C99 standard in which the complex numbers facilities are defined. The C complex type are not implemented as such in the Microsoft C Runtime library, and they recommend using platform-specific and non-standard, but binary compatible, alternatives instead.</p><table><thead><tr><th style=text-align:left>Standard type</th><th style=text-align:left>Microsoft type</th></tr></thead><tbody><tr><td style=text-align:left><strong><code>float complex</code></strong> or <strong><code>float _Complex</code></strong></td><td style=text-align:left><strong><code>_Fcomplex</code></strong></td></tr><tr><td style=text-align:left><strong><code>double complex</code></strong> or <strong><code>double _Complex</code></strong></td><td style=text-align:left><strong><code>_Dcomplex</code></strong></td></tr><tr><td style=text-align:left><strong><code>long double complex</code></strong> or <strong><code>long double _Complex</code></strong></td><td style=text-align:left><strong><code>_Lcomplex</code></strong></td></tr></tbody></table><p>Microsoft is developing an open-source implementation of the C++ standard library on GitHub: <a href=https://github.com/microsoft/STL>microsoft/STL</a>, which has picked up a lot of momentum over time. It is the most complete implementation of the C++23 standard library at the time of writing this document (2023/03/24) !</p><p>The issue is that the UCRT and the C++ STL implementation are handled by different teams. So the Microsoft C++ standard library implementation is <a href=https://github.com/microsoft/STL/issues/3280>not supporting</a> the C types recommended by Microsoft ! It means that any user library relying on those C types in their public API would fail when consumed from a C++ application or library ! Unless&mldr; unless the C developers took time to consider that their code would be used from C++17 onwards and test their library accordingly. They would then, <a href=https://github.com/opencollab/arpack-ng/pull/391>like me</a>, discover the need to define an undocumented escape hatch preprocessor definition to override the <a href=https://eel.is/c++draft/complex.h.syn>C++ standard clause</a> above.</p><p>Instead of introducing <em>non-standard</em> types in the C++ <em>standard</em> library, understandably so, the issue has been redirected to the <a href=https://github.com/MicrosoftDocs/cpp-docs>documentation repository</a> behind <a href=https://learn.microsoft.com/cpp>learn.microsoft.com/cpp</a> for documenting the undocumented escape hatch <code>_CRT_USE_C_COMPLEX_H</code>. Unfortunately, in order to use the recommended types above, one will necessarily spill the complex functions into the global namespace for every downstream developer.</p><h3 id=your-help-would-be-greatly-appreciated>Your help would be greatly appreciated</h3><p>While on my streak, I have been <a href=https://github.com/opencollab/arpack-ng/pull/391#issuecomment-1397465085>asked</a> to see if I could do something for enabling tests for the CI on Windows. A quick logging session later and several CI runs later, <a href=https://github.com/opencollab/arpack-ng/pull/392>TADA</a> üéâ The CI is fixed on Windows for regular tests <em>and</em> the MPI ones.</p><h3 id=back-to-vcpkg>Back to VCPKG</h3><p>On a last stretch of my ballad turned into a marathon, the port of arpack-ng for vcpkg was published and <a href=https://github.com/microsoft/vcpkg/pull/29248>merged</a> without difficulties, after a <a href=https://github.com/opencollab/arpack-ng/issues/394>new release</a> had been cut to be able to set the right versioning system for the vcpkg database.</p><h2 id=epilogue>Epilogue</h2><p>Through this adventure I was led to interact with several major repositories, implementing several fixes, and hopefully improving (to a small scale) the general state of the C/C++ ecosystem, by helping to build ARPACK simply across platforms and pushing for clarification for C/C++ complex types on Windows. Now that this side quest is completed, time to get back onto the main storyline <a href=#once-upon-a-vegafem>‚§¥</a> üòÑ</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://dl.acm.org/doi/10.5555/1354115>Real-time reduced large-deformation models and distributed contact for computer graphics and haptics.</a> ‚Äî¬†Jernej Barbiƒç, 2007&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://en.wikipedia.org/wiki/Modal_analysis_using_FEM>Modal analysis using FEM</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main><footer id=footer><div id=footer-inner>&copy;&nbsp;2020-2024&nbsp;&#183;&nbsp;Fabien P√©an</div></footer><script>window.FontAwesomeConfig={searchPseudoElements:!0}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js integrity="sha512-6PM0qYu5KExuNcKt5bURAoT6KCThUmHRewN3zUFNaoI6Di7XJPTMoT6K0nsagZKk2OB4L7E3q1uQKHNHd4stIQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js integrity="sha512-yUUc0qWm2rhM7X0EFe82LNnv2moqArj5nro/w1bi05A09hRVeIZbN6jlMoyu0+4I/Bu4Ck/85JQIU82T82M28w==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.2/mermaid.min.js integrity="sha512-8ZrL1m0+KXHylxkFJdFtFCauQdV/KZMjSBL9iydsyIfiB1LwYBlGegX8dUlLnUtRDrTgWKP6pPVyOqa2VrqoNA==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>mermaid.initialize({startOnLoad:!0,securityLevel:"loose",theme:"default",themeCSS:"",cloneCssStyles:!0,useMaxWidth:!0,htmlLabels:!1,flowchart:{curve:"basis"}})</script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!1,processEnvironments:!0,tags:"ams"},svg:{fontCache:"global",displayAlign:"left",displayIndent:"2emem"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script src=/js/custom.js></script></body></html>